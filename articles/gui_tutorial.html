<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Targeted peak integration of LC-MS data using T.A.R.D.I.S. • TARDIS</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Targeted peak integration of LC-MS data using T.A.R.D.I.S.">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">TARDIS</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/case_study.html">Case study: targeted metabolite detection using TARDIS in cardiovascular disease</a></li>
    <li><a class="dropdown-item" href="../articles/gui_tutorial.html">Targeted peak integration of LC-MS data using T.A.R.D.I.S.</a></li>
    <li><a class="dropdown-item" href="../articles/quick_start.html">Quick start for targeted peak integration of LC-MS data using TARDIS</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Targeted peak integration of LC-MS data using T.A.R.D.I.S.</h1>
                        <h4 data-toc-skip class="author">Pablo
Vangeenderhuysen</h4>
            
            <h4 data-toc-skip class="date">2025-10-23</h4>
      

      <div class="d-none name"><code>gui_tutorial.rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p><code>T.A.R.D.I.S.</code> is an R package developed by Pablo
Vangeenderhuysen at LIMET, Ghent University. <code>T.A.R.D.I.S.</code>
offers an easy and straightforward way to automatically calculate area
under the peak, max intensity and various quality metrics for targeted
chemical compounds in LC-MS data. It makes use of an established
retention time correction algorithm from the <code>xcms</code> package
and loads MS data as <code>Spectra</code> objects so it’s easily
integrated with other tools of the <em>Rformassspectrometry</em>
initiative.</p>
<p>See <a href="https://github.com/pablovgd/T.A.R.D.I.S./blob/main/README.md" class="external-link">README</a>
for installation instructions.</p>
<p>This tutorial explains the basic functionality of
<code>T.A.R.D.I.S.</code> and how to use the Shiny GUI. It’s advised to
read this tutorial until the end before using <code>T.A.R.D.I.S.</code>
to understand how the tool works and what kind of input is needed.</p>
</div>
<div class="section level2">
<h2 id="targeted-data-processing-with-t-a-r-d-i-s-">Targeted data processing with T.A.R.D.I.S.<a class="anchor" aria-label="anchor" href="#targeted-data-processing-with-t-a-r-d-i-s-"></a>
</h2>
<div class="section level3">
<h3 id="the-general-workflow">The general workflow<a class="anchor" aria-label="anchor" href="#the-general-workflow"></a>
</h3>
<p><code>T.A.R.D.I.S.</code> was developed as an open-source alternative
for targeted peak integration using simple and interpretable algorithms.
It’s general workflow is as follows:</p>
<ul>
<li>Create a target list</li>
<li>Screening step</li>
<li>Retention time (RT) alignment of samples</li>
<li>Peak detection in QCs and adjustment of expected retention time</li>
<li>Peak detection in samples</li>
<li>Calculate quality metrics of peaks and summarize results</li>
</ul>
<div class="section level4">
<h4 id="creating-a-target-list">Creating a target list<a class="anchor" aria-label="anchor" href="#creating-a-target-list"></a>
</h4>
<p>The first step is creating a <code>data.frame</code> that describes
the chemical compounds. Following columns at least need to be present
for each compound:</p>
<ul>
<li>A compound ID, a unique identifier</li>
<li>A compound Name</li>
<li>Theoretical or measured <em>m/z</em>
</li>
<li>Expected RT (in minutes)</li>
<li>A column that indicates the polarity of the formed ion for that
compound</li>
</ul>
<p>Extra columns can be included in the file, but will be ignored by
<code>T.A.R.D.I.S.</code> unless otherwise indicated.</p>
<p>An input file (either .xlsx or .csv) can be converted to a correct
data.frame using the <code><a href="../reference/createTargetList.html">createTargetList()</a></code> function (not
needed if using the GUI). Input parameters needed are: the path to the
file, the patterns for positive and negative ionization, the polarity of
interest, the columnn that contains the ionization mode and the other
columns of interest.</p>
<p>An example:</p>
<p>Input file looks like this (first 6 rows):</p>
<table class="table">
<thead><tr class="header">
<th align="right">id</th>
<th align="left">name</th>
<th align="left">mz</th>
<th align="left">ion</th>
<th align="left">rt</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">49</td>
<td align="left">Valeric acid</td>
<td align="left">103.07536</td>
<td align="left">+</td>
<td align="left">8.4</td>
</tr>
<tr class="even">
<td align="right">76</td>
<td align="left">Malic acid</td>
<td align="left">133.01424</td>
<td align="left">-</td>
<td align="left">1.21</td>
</tr>
<tr class="odd">
<td align="right">82</td>
<td align="left">Pyruvic acid</td>
<td align="left">87.008769999999998</td>
<td align="left">-</td>
<td align="left">1.48</td>
</tr>
<tr class="even">
<td align="right">86</td>
<td align="left">(R)-(+)-Methylsuccinic acid</td>
<td align="left">133.04954000000001</td>
<td align="left">+</td>
<td align="left">4.2</td>
</tr>
<tr class="odd">
<td align="right">89</td>
<td align="left">Azelaic acid</td>
<td align="left">187.09757999999999</td>
<td align="left">-</td>
<td align="left">8.77</td>
</tr>
<tr class="even">
<td align="right">91</td>
<td align="left">Sebacic acid </td>
<td align="left">201.11322999999999</td>
<td align="left">-</td>
<td align="left">9</td>
</tr>
</tbody>
</table>
<p>The target <code>data.frame</code> is created:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">targets</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/createTargetList.html">createTargetList</a></span><span class="op">(</span><span class="st">"vignette_data/targets.xlsx"</span>,</span>
<span>                            pos_pattern <span class="op">=</span> <span class="st">"+"</span>,</span>
<span>                            neg_pattern <span class="op">=</span> <span class="st">"-"</span>,</span>
<span>                            polarity <span class="op">=</span> <span class="st">"positive"</span>,</span>
<span>                            ion_column <span class="op">=</span> <span class="st">"ion"</span>,</span>
<span>                            columns_of_interest <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"name"</span>, <span class="st">"mz"</span>, <span class="st">"rt"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">kableExtra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">targets</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left"></th>
<th align="left">ID</th>
<th align="left">NAME</th>
<th align="right">m/z</th>
<th align="right">tr</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">1</td>
<td align="left">49</td>
<td align="left">Valeric acid</td>
<td align="right">103.07536</td>
<td align="right">504.0</td>
</tr>
<tr class="even">
<td align="left">4</td>
<td align="left">86</td>
<td align="left">(R)-(+)-Methylsuccinic acid</td>
<td align="right">133.04954</td>
<td align="right">252.0</td>
</tr>
<tr class="odd">
<td align="left">8</td>
<td align="left">98</td>
<td align="left">Urocanic acid </td>
<td align="right">139.05020</td>
<td align="right">79.8</td>
</tr>
<tr class="even">
<td align="left">9</td>
<td align="left">169</td>
<td align="left">L-Alanine</td>
<td align="right">90.05496</td>
<td align="right">51.6</td>
</tr>
<tr class="odd">
<td align="left">10</td>
<td align="left">170</td>
<td align="left">L-Valine</td>
<td align="right">118.08626</td>
<td align="right">78.0</td>
</tr>
<tr class="even">
<td align="left">11</td>
<td align="left">171</td>
<td align="left">L-Leucine</td>
<td align="right">132.10191</td>
<td align="right">132.0</td>
</tr>
</tbody>
</table>
</div>
<div class="section level4">
<h4 id="screening-and-adjusting-expected-retention-time">Screening and adjusting expected retention time<a class="anchor" aria-label="anchor" href="#screening-and-adjusting-expected-retention-time"></a>
</h4>
<p>In this step, 5 QC runs are processed to check if provided expected
retention time is precise enough for consistent integration. These 5 QCs
are automatically picked and will represent beginning, middle and end of
the analysis. If the analysis is suffering from retention time drift
and/or the compound is not eluting at its expected RT, this will become
apparent in this quick screening. If necessary, changes can be made to
the input targets table and one can proceed to processing all samples
and results.</p>
<p>To perform this screening step, in the GUI “screening mode” should be
checked or when using the command line, the argument
<code>screening_mode</code> should be <code>TRUE</code>.</p>
<p>An example of a compound for which the retention time could be
adjusted is shown in Figure 1.</p>
<p>If retention shift is too severe and can not be be mediated by the
retention time correction step (see next section), it can happen that a
peak from a QC run in the beginning of the analysis will barely be in
the same window as a peak from a QC run at the end of the analysis. To
resolve this, performing the processing in different “batches” is
advised, see later for details.</p>
<div class="float">
<img src="vignette_data/plots/screening_mode.png" alt="Figure 1"><div class="figcaption">Figure 1</div>
</div>
<p>From the above figure and our knowledge of the compound, we can see
that the compound is present, but eluting later than expected. Adjusting
the expected RT in the targets file makes sure the compound is visible
in our window and integration will happen correctly. See Figure 2.</p>
<div class="float">
<img src="vignette_data/plots/screening_mode_2.png" alt="Figure 2"><div class="figcaption">Figure 2</div>
</div>
</div>
<div class="section level4">
<h4 id="retention-time-alignment">Retention time alignment<a class="anchor" aria-label="anchor" href="#retention-time-alignment"></a>
</h4>
<p>In order to deal with RT shift in longer analyses, a RT
correction/sample alignment is done based on found peaks of internal
standard compounds in quality control (QC) samples. The alignment is
performed using the <code>adjustRtime()</code> function from
<code>xcms</code> using the <code>PeakGroupsParam</code> parameter: this
performs retention time correction based on the alignment of features
defined in all/most samples (corresponding to house keeping compounds or
marker compounds) (Smith 2006). In our case, these house keeping
compounds are manually defined to be the internal standard compounds as
they should always be present and have good quality peaks. This is done
with the <code>peakGroupsMatrix</code> parameter. For more details: <a href="https://github.com/sneumann/xcms/issues/715" class="external-link uri">https://github.com/sneumann/xcms/issues/715</a></p>
<p>Plots below show results for two components in 5 QC runs without RT
correction (left) and with RT correction (right).</p>
<p><img src="vignette_data/plots/not_aligned_180.png" width="45%"><img src="vignette_data/plots/aligned_180.png" width="45%"></p>
<p><img src="vignette_data/plots/not_aligned_181.png" width="45%"><img src="vignette_data/plots/aligned_181.png" width="45%"></p>
</div>
<div class="section level4">
<h4 id="peak-detection-in-qcs-and-adjusting-expected-rt">Peak detection in QC’s and adjusting expected RT<a class="anchor" aria-label="anchor" href="#peak-detection-in-qcs-and-adjusting-expected-rt"></a>
</h4>
<p>Based on the expected RT, target compounds are integrated in quality
control samples. As said, in severe cases of RT shift, RT correction
sometimes isn’t able to align all samples throughout the whole analysis.
This behavior should be visible after running screening mode, if QCs
from beginning and end of the analysis aren’t properly aligned, it might
be advised to run the analysis in batches. To deal with a different
expected RT per batch, target compounds are first integrated in the QCs
from that batch, after which expected RT is adjusted to the RT at which
the compounds are retrieved (or almost retrieved) in the QCs. In the
next step, all runs (QCs and samples) in that batch are processed with
the adjusted RT.</p>
<p>An example: in the Figures below, the compound is clearly eluting at
a different time in QC runs at the beginning of the analysis (left),
compared to QC runs at the end of the analysis (right). In order to
avoid having to manually provide expected RT for every batch,
<code>T.A.R.D.I.S.</code> will detect that the peak apex is now closer
to a RT of 440 seconds (7.3 minutes) and thus when finally processing
that batch the expected RT for that compound will be approximately 440
seconds instead of 446 seconds.</p>
<p><img src="vignette_data/plots/rtshift1.png" width="45%"><img src="vignette_data/plots/rtshift2.png" width="45%"></p>
</div>
<div class="section level4">
<h4 id="peak-detection-in-samples">Peak detection in samples<a class="anchor" aria-label="anchor" href="#peak-detection-in-samples"></a>
</h4>
<p>Finally, after setting the new expected RT, peaks are integrated in
all samples (and QCs). The user can choose to get plots for all
components in all samples and QCs (plotted in groups of 5 samples, see
example below).</p>
<p><img src="vignette_data/plots/sample_plot.png" width="45%"></p>
</div>
<div class="section level4">
<h4 id="quality-metrics-and-output-files">Quality metrics and output files<a class="anchor" aria-label="anchor" href="#quality-metrics-and-output-files"></a>
</h4>
<p>The following files will be created in the chosen output folder:</p>
<ul>
<li>Folders with desired plots (Diagnostic plots, QCs, samples)</li>
<li>A feature overview table with average metrics of the compounds in
the QC runs</li>
<li>Result tables with different attributes of each compound in each
sample:
<ul>
<li>Area under the curve (auc_table)</li>
<li>Max peak intensity (int_table)</li>
<li>Correlation score (peakcor_table)</li>
<li>Points over the peak (pop_table)</li>
<li>Signal to noise (snr_table)</li>
</ul>
</li>
</ul>
<p>The signal to noise and correlation score are adapted from <a href="https://bmcbioinformatics.biomedcentral.com/articles/10.1186/s12859-023-05533-4" class="external-link">Kumler
et al. (2023)</a>. From the publication, these two metrics showed to be
the best predictors of actual peak quality, and thus can be useful to
screen for compounds that are consistently low quality and/or need to be
defined as “Not Found”.</p>
<p>Currently filtering results using the GUI is only available based on
max intensity.</p>
</div>
</div>
<div class="section level3">
<h3 id="starting-the-gui">Starting the GUI<a class="anchor" aria-label="anchor" href="#starting-the-gui"></a>
</h3>
<p>First, after installation, load the package:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pablovgd.github.io/TARDIS/">TARDIS</a></span><span class="op">)</span></span></code></pre></div>
<p>To launch the GUI run:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/runTardis.html">runTardis</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>The Shiny GUI will open in an RStudio window or your browser:</p>
<p><img src="vignette_data/screenshots/create_list.png" width="60%"></p>
<div class="section level4">
<h4 id="creating-a-target-list-1">Creating a target list<a class="anchor" aria-label="anchor" href="#creating-a-target-list-1"></a>
</h4>
<p>In the tab “Create target list”, one can adjust the following
parameters:</p>
<ul>
<li>Input table with target compounds, in .csv or .xlsx format</li>
<li>The pattern that is unique for compounds forming positive ions, to
be found in the ion column</li>
<li>The pattern that is unique for compounds forming negative ions, to
be found in the ion column</li>
<li>The name of the ion column in which to retrieve the pattern</li>
<li>The columns of interest one wants to retain in the output
(id,name,mz and rt are mandatory)</li>
</ul>
<p>Pressing “Create Target List” after filling in the parameter fields
will create a target list and pass it through for the next part.</p>
<p><img src="vignette_data/screenshots/list_created.png" width="60%"></p>
</div>
<div class="section level4">
<h4 id="targeted-peak-detection">Targeted peak detection<a class="anchor" aria-label="anchor" href="#targeted-peak-detection"></a>
</h4>
<p>In the tab “Targeted peak detection”, one can adjust the following
parameters:</p>
<ul>
<li><p>Data folder path containing the .mzML files</p></li>
<li><p>Folder path to store the output</p></li>
<li><p>PPM: allowed <em>m/z</em> error in ppm</p></li>
<li><p>Custom mass range: In case of analysis with multiple mass-ranges
at different time windows: enter the desired mass window, see quick
start vignette.</p></li>
<li><p>RT deviation: search window visible to the peak picking algorithm
around the expected RT (e.g. 18 means +- 9 seconds around the expected
RT)</p></li>
<li><p>Internal standard IDs: IDs of the internal standard compounds
that will be used for RT alignment</p></li>
<li><p>Batch positions: in pairs, the beginning and end position of
files in a batch. E.g. 1,20,21,40 means that file 1 up to and including
20 are in batch 1, and file 21 up to and including 40 are in batch
2</p></li>
<li><p>Sample pattern: if .mzML files of sample runs have a unique
identifier, indicate it here, if nothing is entered, all .mzML files
that DO NOT have the QC identifier are marked as sample</p></li>
<li><p>QC pattern: entern the pattern unique for QC .mzML files</p></li>
<li><p>Generate diagnostic plots: create diagnostic plots of 5 QCs
automatically selected from beginning, middle and end of the
analysis</p></li>
<li><p>Generate sample plots: create plots for all the compounds in all
the sample runs</p></li>
<li><p>Generate QC plots: create plots for all the compounds in all the
QC runs</p></li>
<li><p>Screening mode: fast processing mode that only processes 5 QC
runs from beginning, middle and end of analysis</p></li>
<li><p>RT alignment: wether or not to perform RT alignment.</p></li>
<li><p>Smoothing: apply smoothing (attention! this also means that the
quality metrics are computed for the smoothed peaks and not the raw
data). For a first and honest look at data quality, I would advise to
leave this off.</p></li>
<li><p>Minimum peak intensity: a minimum maximum intensity threshold for
the peaks. Peaks with a maximum intensity less than the threshold are
excluded from the results (NA in results table).</p></li>
</ul>
<p><img src="vignette_data/screenshots/target_peak_detection.png"><!-- --></p>
<p><img src="vignette_data/screenshots/input.png"><!-- --></p>
<p>During processing, wait patiently:</p>
<p><img src="vignette_data/screenshots/processing.png"><!-- --></p>
<p>When processing is finished, a message will appear:</p>
<p><img src="vignette_data/screenshots/processing_done.png"><!-- --></p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="issues-and-feature-requests">Issues and feature requests<a class="anchor" aria-label="anchor" href="#issues-and-feature-requests"></a>
</h2>
<p><code>T.A.R.D.I.S.</code> will receive periodical updates including
improvements and/or new features based on the need of the users. If you
encounter an error, or any other problem, feel free to create an issue
on Github. Got an idea yourself to improve <code>T.A.R.D.I.S.</code>?
Feature requests are also more than welcome.</p>
<p><a href="https://github.com/pablovgd/T.A.R.D.I.S./issues" class="external-link uri">https://github.com/pablovgd/T.A.R.D.I.S./issues</a></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Pablo Vangeenderhuysen.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
